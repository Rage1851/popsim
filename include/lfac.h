/*
 *      Filename: lfac.c
 *   Description: Logarithmic factorial implementation via stirling's approximation which is about
 *                twice as fast as lgamma and about 18 times as fast when inlined. It has more bits
 *                of precision than provided by a double.
 *        Author: Niklas Mamtschur
 *  Organization: Technical University of Munich (TUM)
 */

#ifndef LFAC_H
#define LFAC_H

#include <math.h>

typedef unsigned long long ullong;
typedef long double        ldouble;

#define LFAC_NLOOKUP     100LLU
#define LFAC_LN_SQRT_2PI 0.91893853320467278056327131707803346216678619384765625L
#define LFAC_ONEDIV12    0.08333333333333332870740406406184774823486804962158203125L
#define LFAC_ONEDIV360   0.0027777777777777778837886568652493224362842738628387451171875L

static const ldouble lfac_lookup[] = {
    0.L,
    0.L,
    0.6931471805599453972490664455108344554901123046875L,
    1.7917594692280551793572840324486605823040008544921875L,
    3.178053830347945307721602148376405239105224609375L,
    4.78749174278204492338772979564964771270751953125L,
    6.5792512120101012129680384532548487186431884765625L,
    8.5251613610654128905252946424297988414764404296875L,
    10.6046029027452473059156545787118375301361083984375L,
    12.8018274800814690905781390029005706310272216796875L,
    15.1044125730755158798501724959351122379302978515625L,
    17.5023078458738865492705372162163257598876953125L,
    19.9872144956618882360999123193323612213134765625L,
    22.552163853123420977908608620055019855499267578125L,
    25.19122118273867982907177065499126911163330078125L,
    27.89927138384089033706914051435887813568115234375L,
    30.6718601060806719260654062964022159576416015625L,
    33.5050734501368907558571663685142993927001953125L,
    36.39544520803304550327084143646061420440673828125L,
    39.339884187199487541874987073242664337158203125L,
    42.3356164607534850574666052125394344329833984375L,
    45.3801388984769147327824612148106098175048828125L,
    48.47118135183522014131085597909986972808837890625L,
    51.60667556776437692178660654462873935699462890625L,
    54.784729398112318676794529892504215240478515625L,
    58.00360522298051790812678518705070018768310546875L,
    61.261701761002001376255066134035587310791015625L,
    64.5575386270063376059624715708196163177490234375L,
    67.8897431371815400780178606510162353515625L,
    71.257038967168000453966669738292694091796875L,
    74.6582363488301581355699454434216022491455078125L,
    78.0922235533153070718981325626373291015625L,
    81.55795945611504293992766179144382476806640625L,
    85.054467017581515619895071722567081451416015625L,
    88.5808275421976674124380224384367465972900390625L,
    92.1361756036870929165161214768886566162109375L,
    95.7196945421432019429630599915981292724609375L,
    99.330612454787427623159601353108882904052734375L,
    102.9681986145138097299422952346503734588623046875L,
    106.631760260643460469509591348469257354736328125L,
    110.3206397147574051587071153335273265838623046875L,
    114.0342117814617068916049902327358722686767578125L,
    117.771881399745069529672036878764629364013671875L,
    121.533081515438624364833231084048748016357421875L,
    125.3172711493568982632496044971048831939697265625L,
    129.123933639127216110864537768065929412841796875L,
    132.952575035616320064946194179356098175048828125L,
    136.8027226373263829373172484338283538818359375L,
    140.673923648234250549649004824459552764892578125L,
    144.565743946344895221045590005815029144287109375L,
    148.477766951773020309701678343117237091064453125L,
    152.409592584497346479111001826822757720947265625L,
    156.360836303078798437127261422574520111083984375L,
    160.331128216630901306416490115225315093994140625L,
    164.32011226319519892058451659977436065673828125L,
    168.32744544842768164016888476908206939697265625L,
    172.3527971391628170749754644930362701416015625L,
    176.39584840699734513691510073840618133544921875L,
    180.456291417543781108179246075451374053955078125L,
    184.5338288614494786088471300899982452392578125L,
    188.628173423671597674911026842892169952392578125L,
    192.739047287844897482500527985394001007080078125L,
    196.8661816728899793815799057483673095703125L,
    201.009316399281516396513325162231922149658203125L,
    205.168199482641199438148760236799716949462890625L,
    209.342586752536789163059438578784465789794921875L,
    213.532241494563237438342184759676456451416015625L,
    217.73693411395424845977686345577239990234375L,
    221.95644181913036163678043521940708160400390625L,
    226.190548323727625756873749196529388427734375L,
    230.4390435657769558019936084747314453125L,
    234.70172344281826326550799421966075897216796875L,
    238.97838956183431946556083858013153076171875L,
    243.26884900298273350927047431468963623046875L,
    247.572914096186877941363491117954254150390625L,
    251.890402209723191617740667425096035003662109375L,
    256.2211355500095351089839823544025421142578125L,
    260.56494097186322278503212146461009979248046875L,
    264.92164979855277806564117781817913055419921875L,
    269.29109765101981111001805402338504791259765625L,
    273.67312428569374560538562946021556854248046875L,
    278.0675734403661181204370222985744476318359375L,
    282.47429268763045229206909425556659698486328125L,
    286.89313329542693509210948832333087921142578125L,
    291.32395009427028753634658642113208770751953125L,
    295.76660135076059532366343773901462554931640625L,
    300.2209486470140973324305377900600433349609375L,
    304.6868567656687218914157710969448089599609375L,
    309.16419358014690033087390474975109100341796875L,
    313.65282994987904885419993661344051361083984375L,
    318.15263962020929966456606052815914154052734375L,
    322.66349912672620803277823142707347869873046875L,
    327.18528770377525916046579368412494659423828125L,
    331.7178871969284728038473986089229583740234375L,
    336.261181979198454428114928305149078369140625L,
    340.81505887079902095138095319271087646484375L,
    345.379407062266864159028045833110809326171875L,
    349.954118040770254083327017724514007568359375L,
    354.5390855194408459283295087516307830810546875L,
    359.1342053695753975262050516903400421142578125L,
    363.7393755555634697884670458734035491943359375L,
};

/*
 *  Description: Computes the logarithmic factorial of n.
 */
static inline ldouble lfac(ullong n) {
    return (n <= LFAC_NLOOKUP) ? lfac_lookup[n] :
        LFAC_LN_SQRT_2PI + (n+0.5L)*log(n)-n + (LFAC_ONEDIV12-(LFAC_ONEDIV360/((1.L*n)*n)))/n;
}

#endif
